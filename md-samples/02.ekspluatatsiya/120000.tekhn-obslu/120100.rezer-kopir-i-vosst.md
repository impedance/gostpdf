# Резервное копирование и восстановление данных

Периодическое создание резервной копии данных позволяет сохранять актуальную конфигурацию и различные типы данных РОСА Центр Управления, и в случае возникновения внештатной ситуации (в том числе при повреждении файлов ПО Комплекса) осуществлять восстановление необходимых данных из резервной копии.

Процедуры создания резервной копии и восстановления данных осуществляются пользователем Комплекса в терминальном окне узла РОСА Центр Управления.

## Создание резервной копии данных

Резервная копия РОСА Центр Управления должна содержать следующие типы данных:

- дамп БД – файл, содержащий структуру и содержимое таблиц БД Комплекса;
- конфигурационные настройки Комплекса;
- сертификаты SSL сервера Puppet.

Для различных типов данных должны использоваться отдельные процедуры резервного копирования и восстановления.

Для создания дампа БД выполняют следующую команду:

```bash Terminal
foreman-rake db:dump
```

В результате выполнения этой команды будет создан файл с текущим дампом БД и будет указано расположение этого файла относительно каталога /etc/foreman. При необходимости отдельно копируют файл дампа БД на внешний носитель.

Для создания архива с конфигурацией РОСА Центр Управления выполняют следующую команду:

```bash Terminal
tar --selinux -czvf etc_foreman_dir.tar.gz /etc/foreman
```

где etc_foreman_dir.tar.gz – наименование файла для сохранения архива.

Для создания архива с сертификатами SSL сервера Puppet выполняют следующую команду:

```bash Terminal
tar --selinux -czvf var_lib_puppet_dir.tar.gz /etc/puppetlabs/ puppet/ssl
```

где var_lib_puppet_dir.tar.gz – наименование файла для сохранения архива.

Кроме того, при необходимости выполняют резервное копирование данных и конфигурационных файлов для сетевых сервисов DHCP и TFTP, а также систем оркестрации:

- для сервиса DHCP – каталог /etc/dhcp;
- для сервиса TFTP – каталог /var/lib/tftpboot;
- каталог с классами Puppet /etc/puppetlabs/code;
- каталог с плейбуками Ansible /usr/share/ansible/collections/ansible_collections.

## Восстановление данных из резервной копии

В общем случае процедура восстановления данных осуществляется на том же узле, на котором была создана резервная копия.

В случае миграции РОСА Центр Управления на другой узел учитывают возможные различия в конфигурации между этими двумя узлами (например, использование различных IP-адресов и других сетевых параметров, изменение доменного имени узла и тому подобные).

**Следует обратить внимание**, что перед выполнением процедуры восстановления данных необходимо остановить работу сервера РОСА Центр Управления.

Для восстановления структуры и содержимого таблиц БД Комплекса выполняют следующую команду:

```bash Terminal
foreman-rake db:import_dump file=<путь к файлу с дампом БД>
```

Для восстановления конфигурации РОСА Центр Управления выполняют команду:

```bash Terminal
tar --selinux -xzvf etc_foreman_dir.tar.gz -C
```

где etc_foreman_dir.tar.gz – наименование файла с архивом резервной копии.

Для восстановления сертификатов SSL сервера Puppet выполняют команду:

```bash Terminal
tar --selinux -xzvf var_lib_puppet_dir.tar.gz -C
```

где var_lib_puppet_dir.tar.gz – наименование файла с архивом резервной копии.

Кроме того, при необходимости выполняют восстановление данных и конфигурационных файлов для сетевых сервисов DHCP и TFTP, а также систем оркестрации:

- для сервиса DHCP – каталог /etc/dhcp;
- для сервиса TFTP – каталог /var/lib/tftpboot;
- каталог с классами Puppet /etc/puppetlabs/code;
- каталог с плейбуками Ansible
- /usr/share/ansible/collections/ansible_collections.