# Регистрация существующих узлов

Для успешной регистрации в РОСА Центр Управления существующий узел (ранее развернутый не под управлением Комплекса) должен соответствовать следующим предварительным условиям:

- основным сервером DNS регистрируемого узла должен быть сервер СИПА либо сервер DNS, который настроен так, что позволяет разрешать записи DNS сервера СИПА;
- на узле должны быть настроены источники пакетов, которые содержат пакеты puppet-agent;
- в случае использования стороннего сертификата для веб-интерфейса РОСА Центр Управления вместо самоподписанного сертификата ЦС Puppet на регистрируемый узел должен быть добавлен соответствующий сертификат CA (сертификат корневого доверенного ЦС) – файл `/etc/foreman/ca.pem`;
- узлу должны быть доступны следующие сетевые порты сервера РОСА Центр Управления:
  - `TCP/443` – HTTPS;
  - `TCP/8140` – Puppet;
- узлу должны быть доступны следующие сетевые порты сервера СИПА:
  - `TCP/80`, `TCP/443` – HTTP/HTTPS;
  - `TCP/389`, `TCP/636` – LDAP/LDAPS;
  - `TCP,UDP/88`, `TCP,UDP/464` – Kerberos;
  - `TCP,UDP/53` – DNS;
  - `UDP/123` – NTP.

> Примечание – При необходимости можно настроить для регистрируемых узлов правила автоподписывания сертификатов Puppet (п.3.4 документа "Платформа централизованного управления жизненным циклом операционных систем "РОСА Центр Управления". Руководство системного администратора. Часть 1. Установка и настройка" (шифр РСЮК.10121-08 32 01)).

Для подключения агента puppet требуется:

- открыть сессию от имени суперпользователя root на узле, который необходимо подключить к серверу РОСА Центр Управления;
- открыть в текстовом редакторе файл конфигурации (в зависимости от версии ОС) `/etc/puppet/puppet.conf` с помощью команды:

```bash Terminal
mcedit /etc/puppet/puppet.conf
```
- создать или изменить секцию конфигурационного файла [agent] со следующим содержанием:

```bash Terminal
[agent]
ca_server = cc.rosa.int
certname = host.rosa.int
server = cc.rosa.int
```

где:
  - ca_server – FQDN сервера сертификации РОСА Центр Управления;
  - certname – FQDN подключаемого узла;
  - server – FQDN сервера РОСА Центр Управления;

- включить и запустить системный агент puppet, выполнив команду:

```bash Terminal
systemctl enable --now puppet
```

- для проверки запуска агента выполнить команду:

```bash Terminal
puppet agent -t
```

После подготовки узла необходимо перейти в меню "Узлы → Зарегистрировать узел" панели навигации для настройки параметров регистрации узла (рисунок 42).

::sign-image
---
src: /image52.png
sign: Рисунок 42 — Параметры регистрации узла
---
::

В списке "Группа узлов" выбирают группу, в которую будет включен узел, затем выбирают ОС, указывают или создают ключ активации, а остальные параметры регистрации узла можно оставить со значениями по умолчанию.

**Следует обратить внимание**, что выбор группы определяет конфигурацию узла и настройки, которые будут применены к ОС. По умолчанию в РОСА Центр Управления доступны следующие группы узлов:

- Generic – при выборе этой группы применяются преднастроенные параметры сети, а также предоставляются функции дистанционного выполнения команд, скриптов и плейбуков (исполняемых сценариев) Ansible на регистрируемом узле;
- Puppet – при выборе этой группы дополнительно устанавливается и настраивается агент Puppet на регистрируемом узле.

> Примечание – В процессе эксплуатации Комплекса необходимые пользовательские настройки могут быть внесены напрямую в параметры исходных групп, однако рекомендуется сделать копии групп и вносить изменения только в эти копии, а исходные группы использовать в качестве шаблонов.

Выбор ОС должен соответствовать фактически установленной на узел операционной системе, так как в зависимости от указанной версии шаблоны подготовки генерируют различные скрипты регистрации, учитывающие доступные репозитории, версии пакетов программ и прочие специфические аспекты. Таким образом, скрипты регистрации, сгенерированные для одной ОС, в общем случае не могут быть использованы для другой ОС.

После настройки параметров регистрации надо нажать кнопку `Сгенерировать`. В результате в текстовом поле под этой кнопкой появится созданная команда (скрипт регистрации).

Далее копируют эту команду и выполняют в терминале ОС регистрируемого узла.

В случае успешной конфигурации и регистрации узла на экране появится соответствующее сообщение.