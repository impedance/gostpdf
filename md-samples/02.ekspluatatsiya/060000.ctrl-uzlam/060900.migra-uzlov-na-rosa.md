# Миграция узлов на РОСА "Хром"

## Миграция с ОС Windows

### Развертывание сервера обеспечения миграции

Требования к аппаратным средствам сервера, предназначенного для обеспечения миграции, приведены в таблице 2.

::app-collapsible
---
label: "Таблица 2 - Требования к аппаратным средствам сервера обеспечения миграции"
---

#content
<table border="1" cellspacing="0" cellpadding="4">
  <thead>
    <tr>
      <th><strong>Параметр</strong></th>
      <th><strong>Минимальное значение</strong></th>
      <th><strong>Рекомендуемое значение</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Количество ядер процессора</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <td>Объем оперативной памяти, Гбайт</td>
      <td>4</td>
      <td>8</td>
    </tr>
    <tr>
      <td>Свободное дисковое пространство, Гбайт</td>
      <td>2000</td>
      <td>4000</td>
    </tr>
  </tbody>
</table>
::


Для миграции узлов, подключенных к Комплексу, необходимо осуществить предварительное развертывание сервера обеспечения процедуры миграции. Сервер служит временным хранилищем мигрируемых пользовательских данных и резервной копией локальных разделов мигрируемого АРМ.

Благодаря сохраненной резервной копии разделов в случае возникновения необходимости существует возможность отката АРМ в состояние "до миграции" с использованием стандартных утилит ОС Windows.

Для автоматизированного развертывания сервера предусмотрено использование класса rcc_migrator_create_backup_server.

Данный класс имеет два параметра:

- backup_server – IP-адрес или FQDN-имя сервера, выбранного в качестве сервера обеспечения миграции (например, 10.0.0.17);
- backup_folder – расположение каталога на сервере, в котором будет хранится резервная копия разделов мигрируемого АРМ, а также переносимая информация профилей пользователей (например, /srv/migrate).

Для назначения класса Puppet необходимо выполнение следующих шагов:

1. перейти в пункт основного меню "Узлы → Все Узлы" и выбрать сервер;
2. перейти к редактированию сервера, нажав кнопку `Изменить` в столбце "Действия";
3. на вкладке "Puppet ENC" из перечня "Доступные классы" перенести класс rcc_migrator_create_backup_server во "Включенные классы" (рисунок 56);
4. нажать кнопку `Применить`.

::sign-image
---
src: /image66.png
sign: Рисунок 56 — Параметры класса
---
::

После назначения класса на сервер обеспечения миграции и задания параметров (backup_server и backup_folder) произойдет автоматическая установка и настройка необходимых сервисов.

Во время первого запуска класса возможен автоматический перезапуск сервера для изменения настроек безопасности selinux.

### Требования к аппаратному и программному обеспечению узлов

Процедура миграции применяется к физическим узлам в соответствии со следующими требованиями конфигурации:

1. Минимальная конфигурация ПК:
  - ЦП архитектуры x86-64, 2 ядра 1,2 ГГц;
  - ОЗУ 2 ГБ;
  - 20 ГБ свободного дискового пространства на основном накопителе.
2. Рекомендуемая конфигурация ПК:
  - ЦП архитектуры x86-64, 2 ядра 1,2 ГГц;
  - ОЗУ 4 ГБ;
  - 50 ГБ свободного дискового пространства на основном накопителе.
3. Оборудование должно быть совместимо с дистрибутивом развёртываемой отечественной ОС и отвечать его системным требованиям.
4. На узлах в настройках микропрограммы EFI должен быть отключен протокол Secure Boot.
5. На диске, содержащем системный раздел, не должно содержаться динамических и шифрованных разделов.
6. Недопустимы блокировки доступа к информации на диске со стороны систем безопасности. Каталоги пользователей должны быть открыты на чтение и запись.

### Сценарий миграции

Сценарий миграции узлов с Windows-подобной на отечественную ОС включает подготовительные действия оператора миграции и автоматизированные процедуры, выполняемые Комплексом:

1. Проверка средствами ОС Windows готовности узла к миграции на наличие необходимых прав доступа и версий клиентского программного обеспечения. Очистка пользовательских данных от ненужных программ и файлов. Проверка наличия и/или установка на узле Puppet-агента. Это позволяет минимизировать количество сбоев в процессе миграции и сэкономить дисковое пространство на backup-сервере.
2. Включение мигрируемого узла в группу узлов с классами Puppet для миграции или подключение к узлу классов Puppet для миграции с последующим запуском агента Puppet на узле для начала процедуры.
3. Сохранение на backup-сервере данных и настроек пользователей узла. Сохраняются следующие папки пользователей:
  - Загрузки;
  - Документы;
  - Изображения;
  - Рабочий стол.

> Примечание – Папки пользователей сохраняются независимо от месторасположения на дисках и в каталогах.

4. Доставка и установка на системный диск "образа" целевой отечественной операционной системы. По завершении этапа производится запуск целевой ОС.
5. Настройка ОС и программного обеспечения. Завершающий этап, на котором осуществляется ряд процессов, необходимых для ввода узла в эксплуатацию: ввод в домен, подключение к системному прокси-серверу, установка дополнительного ПО, подключение периферийного оборудования, настройка прикладного ПО и информационных систем.

### Процедура миграции

Процедура миграции производится с помощью использования предустановленных классов Puppet (п. Puppet настоящего Руководства).

Для миграции нескольких узлов можно создать отдельную группу, в которую следует добавить все классы Puppet, применяемые ниже.

Для осуществления подготовки к процедуре миграции необходимо выполнение следующих шагов:

1. перейти в пункт основного меню "Узлы ® Все Узлы" и выбрать узел с установленной Windows-подобной ОС и предустановленным Puppet-агентом;
2. перейти к редактированию узла, нажав кнопку `Изменить` в столбце Действия;
3. на вкладке "Puppet ENC" из перечня "Доступные классы" перенести класс rcc_migrator_win_side во "Включенные классы", в котором можно настроить параметры для Windows-части миграции (рисунок 57):
  - backup_letter – задать букву подключаемого сетевого диска резервных копий;
  - backup_server – назначить FQDN-имя или IP-адрес сервера обеспечения миграции;
  - delay_after_backup – задать задержку в секундах по окончании этапа резервного копирования;
  - delay_after_cleaning – задать задержку в секундах по окончании этапа очистки;

::sign-image
---
src: /image67.png
sign: Рисунок 57 — Назначение Puppet-класса узлу
---
::

4. нажать кнопку `Применить`.
5. запустить Puppet-агент на узле по одному из вариантов:
  - выполнение команды:

```bash Terminal
puppet agent -t
```  
  - перезагрузка ОС;
  - перезапуск Windows-службы "Puppet Agent".


Далее производятся следующие действия:

1. автоматизированная очистка дискового пространства узла от вспомогательных, системных и других файлов для оптимизации скорости миграции и размера при создании "образа" сохраняемых данных, по окончании которого будет выдано сообщение "Внимание! Для завершения подготовительного этапа миграции ОС необходимо перезагрузить компьютер. Автоматический перезапуск через 240 секунд" (можно инициировать перезагрузку вручную) (рисунок 58);

::sign-image
---
src: /image68.png
sign: Рисунок 58 — Сообщение после этапа очистки
---
::

2. после перезагрузки автоматизированное сохранение пользовательских данных и снимка "образа" ОС узла, по окончании которого будет выдано сообщение "Внимание! Ваш АРМ готов к проведению миграции. Перезапустите ПК и выберите пункт меню загрузки 'Control Center Discovery Image'. Автоматический перезапуск через 120 секунд" (можно инициировать перезагрузку вручную) (рисунок 59);

::sign-image
---
src: /image69.png
sign: Рисунок 59 — Сообщение после этапа сохранения данных
---
::

> Примечание – Получить статус выполнения заданий по очистке и резервному копированию АРМ под управлением Windows возможно обратившись к факту fact=rcc_migrator_win_status (рисунок 60), воспользовавшись веб-интерфейсом Комплекса.

::sign-image
---
src: /image70.png
sign: Рисунок 60 — Факт о статусе выполнения заданий
---
::

3. после перезагрузки необходимо выбрать из меню загрузки (рисунок 61) пункт "Control Center Discovery Image" для перехода к процедуре миграции;

::sign-image
---
src: /image71.png
sign: Рисунок 61 — Меню загрузки
---
::

4. в процессе загрузки узла появится сообщение (рисунок 62); необходимо дождаться окончания времени обратного отсчета, не нажимая никакие клавиши;

::sign-image
---
src: /image72.png
sign: Рисунок 62 — Сообщение о процессе обнаружения узла
---
::

5. после успешной загрузки узла появится сообщение (рисунок 63)

::sign-image
---
src: /image73.png
sign: Рисунок 63 — Сообщение об успешной загрузке
---
::

6. данные об обновленном узле передаются в Комплекс; нужно перейти в меню "Узлы → Обнаруженные узлы" и убедиться, что появился новый узел (рисунок 64), который необходимо в дальнейшем мигрировать;

::sign-image
---
src: /image74.png
sign: Рисунок 64 — Новый обнаруженный узел
---
::

7. в строке узла в колонке "Действия" нажать `Сетевая установка`; в появившемся модальном окне "Выбор параметров инициализации узла" выбрать из раскрывающихся списков "Группу узлов", для которой заданы параметры установки ОС, "Организацию", "Месторасположение" и нажать кнопку `Настройка узла` (рисунок 65);

::sign-image
---
src: /image75.png
sign: Рисунок 65 — Параметры узла
---
::

8. в рабочей области редактирования узла на вкладке "Puppet ENC" из перечня "Доступные классы" добавить класс rcc_migrator_lin_side во "Включенные классы" в котором можно настроить параметр backup_server – FQDN-имя или IP-адрес сервера восстановления узла к исходному состоянию (рисунок 66);

::sign-image
---
src: /image76.png
sign: Рисунок 66 — Назначение Puppet-класса узлу
---
::

9. нажать кнопку `Применить`;
10. новый узел автоматически перезагрузится и в меню PXE-загрузки теперь нужно выбрать пункт "Kickstart Rosa PXELinux" для миграции на целевую ОС (рисунок );

::sign-image
---
src: /image77.png
sign: Рисунок 67 — Выбор процедуры миграции на новую ОС
---
::

11. далее производится автоматизированная установка новой ОС;
12. после установки появится меню (рисунок 67), в котором для локальной загрузки нужно выбрать пункт "Default local boot" для работы с мигрированным узлом;

::sign-image
---
src: /image78.png
sign: Рисунок 68 — Выбор локальной загрузки для начала работы
---
::

13. при первом входе в домен после миграции сохраненные данные и настройки переносятся в новую целевую ОС.

### Результаты миграции

В результате миграции в конфигурации новой отечественной ОС присутствуют следующие данные и настройки:

- данные всех пользователей узла;
- файлы *.pst почтовой программы;
- сетевые папки общего доступа.

Применение миграции с использованием РОСА Центр Управления имеет следующие преимущества:

- проверка и исправление файловой системы средствами ОС Windows, что снижает риск сбоев в процессе создания образа ВМ в дальнейшем;
- уменьшение объема дисковой информации;
- сокращение времени миграции;
- отсутствие необходимости подготовки дополнительных шаблонов развертывания миграции, так как можно использовать существующие шаблоны развертывания ОС;
- максимальная полнота данных и настроек пользователей узла по сравнению с мигрируемой ОС.

## Установка и миграция с ОС Windows с использованием "золотого образа"

### Требования к оператору миграции

Пользователь Комплекса (оператор миграции) должен иметь следующий опыт:

- Администрирование ОС Windows для установки и настройки программного обеспечения (агент системы оркестрации puppet);
- Установка ОС в Комплексе с использованием PXE;
- Установки ОС в Комплексе с обнаружением узлов;
- Создание/изменение групп узлов;
- Управление АРМ с использование классов Puppet ENC;
- Переопределение классов Puppet ENC;
- Назначение запланированных заданий;
- Знание работы с системами виртуализации для создания образов установленной ОС.

### Подготовка "золотого образа"

При подготовке "золотого образа" необходимо соблюдать следующие условия:

- предусмотреть, чтобы корневой раздел был последним;
- рекомендуется использовать для SWAP размещение в файле;
- рекомендуется предустановить необходимые репозитории, используемые в инфраструктуре;
- рекомендуется предустановить необходимое программное обеспечение, используемое в инфраструктуре;
- обратить внимание при создании образов на режим загрузки MBR/UEFI;
- форматом "золотого образа" должен быть QCOW2;
- для подготовки "золотого образа" должна использоваться система виртуализации, поддерживающая формат дисковой подсистемы QCOW2;
- при использовании физического АРМ необходимо использовать утилиту qemu-img для снятия "золотого образа".

### Подготовка сервера хранения

Сервер хранения предназначен для хранения "золотых образов" и данных с АРМ.

Данные с АРМ включают:

- образ блочного устройства с мигрируемой ОС;
- архивы данных пользователей.

Для подготовки сервера необходимо провести следующие действия:

1. при установке ОС необходимо предусмотреть достаточное свободное дисковое пространство для хранения данных;
2. создать локального пользователя (например, migrator);
3. создать SSH-ключ для данного пользователя; созданный приватный ключ будет использоваться для подключения;
4. настроить конфигурацию SSH-сервера, для подключения созданного пользователя;
5. создать каталог для хранения "золотых образов";
6. владельцем файлов "золотых образов" назначить созданного пользователя;
7. создать каталог для хранения данных с АРМ;
8. владельцем каталога данных с АРМ назначить созданного пользователя.

После подготовки сервера хранения можно проводить процедуры установки (п. Установка ОС) или миграции с ОС Windows (п. Миграция ОС).

### Установка ОС

Для установки используется механизм Комплекса: PXE-сервер в режиме обнаружения узлов.

Для установки ОС из "золотого образа" необходимо преднастроить группу узлов. В качестве эталонной группы в Комплексе создана группа Gold_Deploy.

В свойствах группы Gold_Deploy необходимо определить следующие параметры:

- во вкладке "Группа узлов":

  - Окружение – "production";
  - Прокси Puppet;
  - Прокси центра сертификации Puppet;

- во вкладке "Сеть" установить параметры для домена;
- во вкладке "Операционная система":

  - Архитектура – x86_64;
  - Операционная система – ROSA Enterprise Server Migration Image 9.5.2;
  - Носитель – ROSA Enterprise Server Migration Image 9.5.2;
  - Таблица Разделов – Kickstart default;
  - PXE-загрузчик– выбирается в соответствие с загрузчиком "золотого образа";
  - Пароль пользователя root;

- во вкладке "Параметры":

  - gold_image_name – тип "строка"; задает имя "золотого образа";
  - gold_server_key – тип "строка"; приватный ключ пользователя, от имени которого будет осуществляться подключение;
  - gold_server_name – тип "строка"; IP-адрес сервера хранения;
  - gold_server_path – тип "строка"; путь на сервере хранения для размещения "золотых образов";
  - gold_server_user – тип "строка"; имя пользователя на сервере хранения.

Далее следует установить для группы узлов "Местоположение" и "Организации".

После установки параметров группы узлов необходимо загрузить АРМ в режиме PXE.

Затем требуется в меню загрузки выбрать "Control Center Discovery Image".

После обнаружения узла нужно назначить на него созданную группу узлов.

В результате будет произведена автоматическая перезагрузка и установка новой ОС на АРМ.

### Миграция ОС

Для миграции ОС используется дополнительное окружение "migration".

При миграции ОС поддерживается подключение к домену Dynamic Directory с некоторыми ограничениями к доменам, основанными на FreeIPA: не поддерживается перемещение компьютера в организационное подразделение в связи с отсутствием делегирования прав и реальной иерархии организационных подразделений.

Служебное доменное имя для миграции rosa.migration предназначено для подключения промежуточного образа ОС к Комплексу с автоматическим подписанием сертификата.

#### Описание классов для миграции

Класс подготовки миграции для ОС Windows rcc_migration_windows_prepare, параметры класса и описание:

- default_route – тип "строка"; шлюз для промежуточного образа;
- dns_server – тип "строка"; DNS-сервер для промежуточного образа;
- grub_timeout – тип "строка"; время для загрузки для двойной загрузки в промежуточный образ
- reboot_timeout – тип "строка"; время перезагрузки после установки целевой ОС;
- uefi_letter – тип "строка"; имя диска в Windows для монтирования раздела UEFI;

Класс установки ОС rcc_migration_install_gold_image, параметры класса и описание:

- create_disk_img – тип "логическое значение"; флаг, определяющий создание образа блочного устройства с установленной ОС Windows;
- image_name – тип "строка"; имя файла золотого образа;
- ipa_domain – тип "строка"; имя домена;
- ipa_parentou – тип "строка"; DN организационного подразделения, в которое должен быть помещено АРМ после миграции и ввода в домен;
- ipa_realm_proxy – тип "строка"; имя служебной учетной записи Комплекса для управления учетными записями;
- reboot_timeout – тип "строка"; время перезагрузки после проведения миграции;
- root_password – тип "строка"; пароль пользователя root для промежуточной ОС, который необходим для подключения в случае возникновения возможных ошибок;
- server_data – тип "строка"; каталог на сервере хранения для данных с АРМ;
- server_key – тип "строка"; приватный SSH-ключ пользователя, от имени которого осуществляется подключение к серверу хранения;
- server_name – тип "строка"; IP-адрес сервера хранения;
- server_path – тип "строка"; каталог на сервере хранения для "золотых образов";
- server_user – тип "строка"; пользователь, от имени которого осуществляется подключение к серверу хранения.

Для оптимальной процедуры миграции ОС рекомендуется использование групп хостов с переопределением параметров классов Puppet ENC.

#### Подготовка ОС Windows для проведения миграции

Для подготовки ОС Windows для проведения миграции необходимо соблюдать следующие условия:

- Имя компьютера под управлением MS Windows не должно содержать символы верхнего регистра;
- ОС Windows должна быть подключена к Комплексу. Для подключения к Комплексу с рекомендуемым пакетом для установки puppet-agent-6.28.0-x64.msi нужно создать и выполнить скрипт с необходимыми действиями и параметрами:

```bash Terminal
hostname > myhostname.txt
set /p certname=<myhostname.txt
msiexec.exe /qn /norestart /package puppet-agent-6.28.0
-x64.msi PUPPET_CA_SERVER="FQDN Центра Управления"
PUPPET_MASTER_SERVER="FQDN Центра Управления"
PUPPET_AGENT_ENVIRONMENT="migration"
PUPPET_AGENT_CERTNAME="%certname%.rosa.migration"
```

- При подключении АРМ с ОС Windows следует обратить внимание на установленное время, особенно в среде виртуализации;
- После подключения АРМ с MS Windows хосту нужно назначить группу хостов подготовки миграции для ОС Windows;
- Для ускорения процесса подготовки на мигрируемом АРМ нужно выполнить из командной строки запуск агента от имени администратора командой:

```bash Terminal
puppet agent -t
```

Выполнение агента необходимо провести в два этапа:

- первый запуск – подготавливает ОС, происходит очистка установленной ОС;
- второй запуск – производит установку загрузчика, создает архивы данных пользователей, выводит сообщение, что ОС готова к перезагрузке, происходит перезагрузка в промежуточный образ.

#### Процедура миграции ОС

Миграция происходит с использованием промежуточного образа ОС, в функции которого входит:

- подключение к Комплекса;
- определение раздела/диска, на котором установлена ОС Windows;
- монтирование ресурсов сервера хранения;
- создание образа блочного устройства, на котором установлена ОС Windows;
- копирование данных пользователей;
- копирование "золотого образа" на целевое блочное устройство;
- расширение корневого раздела;
- обновление initramfs;
- установка/обновление агента системы оркестрации Puppet;
- установка/обновление клиента FreeIPA;
- ввод АРМ в домен;
- перемещение АРМ в заданное организационное подразделение;
- конфигурация агента системы оркестрации Puppet;
- копирование данных пользователей на мигрируемый АРМ;
- автоматическая перезагрузка.

После перезагрузки в промежуточный образ АРМ автоматически подключается к Комплексу с именем mig[MAC адрес].rosa.migration.

На данный узел назначается группа узлов установки ОС.

После назначения класса необходимо для данного узла в Комплексе назначить удаленное задание выполнения "Puppet Run Once".

После выполнения задания начнется процесс миграции.

По завершении процесса миграции АРМ автоматически будет введен в домен с заданным организационным подразделением, подключенным к РОСА Центр Управления.

## Миграция с РОСА "Кобальт" с использованием backup-сервера

В качестве исходного состояния при миграции на РОСА "Хром" рассматривается АРМ под управлением ОС РОСА "Кобальт", введенный в домен и с локальным пользователем.

Процедура миграции осуществляется выполнением следующих шагов:

1. в Комплексе создать группу узлов (например, cobalt4migrate), к которой привязать класс rcc_cobalt2chrome (рисунок 69);

::sign-image
---
src: /image79.png
sign: Рисунок 69 — Включение класса rcc_cobalt2chrome
---
::

2. в группу узлов добавить АРМ, который подлежит миграции (на АРМ должен быть установлен и настроен puppet-agent), для чего на вкладке "Узлы" отметить строку с АРМ и по кнопке `Действия` выбрать "Изменить группу" (рисунок 70);

::sign-image
---
src: /image80.png
sign: Рисунок 70 — Изменение группы
---
::

3. выбрать нужную группу и нажать кнопку `Применить` (рисунок 71);

::sign-image
---
src: /image81.jpg
sign: Рисунок 71 — Включение в группу миграции
---
::

3. после включения в группу для миграции на АРМ будет выполнен манифест, по результатам которого осуществятся настройки для начала миграции:

  - резервное копирование всех данных пользователей;
  - создание полного зашифрованного образа для отката в случае непредвиденной ситуации;

> Примечание – Все данные с АРМ передаются на backup-сервер в зашифрованном виде, при этом данные пользователей после миграции будут восстановлены на новой ОС. В зашифрованном архиве data_tar_gz.gpg сохраняются данные пользователей, а в файле sda_img.tar.gz.gpg – зашифрованный образ ОС.

4. по окончании резервного копирования на экране АРМ появится примерно такое сообщение, как на рисунке 72;

::sign-image
---
src: /image82.jpg
sign: Рисунок 72 — Сообщение после резервного копирования
---
::

5. нажать кнопку `ОК` и перезагрузить компьютер с последующей загрузкой по сети и выбором пункта меню "Control Center Discovery Image EFI" (если только ОС до этого была в EFI) (рисунок 73);

::sign-image
---
src: /image83.png
sign: Рисунок 73 — Выбор типа загрузки
---
::

6. в процессе загрузки узла появится сообщение (рисунок 74); необходимо дождаться окончания времени обратного отсчета, не нажимая никакие клавиши;

::sign-image
---
src: /image84.png
sign: Рисунок 74 — Сообщение о процессе обнаружения узла
---
::

7. после успешной загрузки узла появится сообщение об успешной отправке данных на сервер (рисунок 75);

::sign-image
---
src: /image85.jpg
sign: Рисунок 75 — Сообщение об успешной загрузке
---
::

8. в Комплексе перейти в пункт меню "Узлы → Обнаруженные узлы", выбрать в рабочей области требуемый АРМ и нажать кнопку `Сетевая установка` (рисунок 76);

::sign-image
---
src: /image86.png
sign: Рисунок 76 — Выбор сетевой установки для АРМ
---
::

9. в окне (рисунок 77) выбрать ранее настроенную группу узлов "Rosa Chrome/c2c" и нажать кнопку `Создать узел` (переименовывать не нужно, так как мигрированному АРМ будет присвоено то же имя, что было до миграции);

::sign-image
---
src: /image87.jpg
sign: Рисунок 77 — Включение АРМ в преднастроенную группу
---
::

В настройках узла на вкладке "Операционная система" выбрать параметр в списке "Загрузчик PXE" (рисунок 78):

- для UEFI – "Grub2 UEFI";
- для MBR – "PXELinux BIOS";

::sign-image
---
src: /image88.png
sign: Рисунок 78 — Выбор параметра загрузки
---
::

10. после этого на мигрируемом АРМ начнется перезагрузка (по сети), в процессе которой выбрать пункт меню "Kickstart Rosa PXEGrub2", после чего начнется установка, занимающая определенное время;
11. после перезагрузки АРМ уже начнет запускаться под управлением ОС РОСА "Хром" (рисунок 79);

::sign-image
---
src: /image89.jpg
sign: Рисунок 79 — Загрузка РОСА "Хром"
---
::

**Следует обратить внимание**, что после первой загрузки РОСА "Хром" не нужно входить под УЗ пользователя, так как в это время копируются пользовательские данные, а по окончании будет выполнена перезагрузка в автоматическом режиме. На экране входа отобразятся локальные пользователи, которые были ранее в ОС РОСА "Кобальт" (рисунок 80);

::sign-image
---
src: /image90.jpg
sign: Рисунок 80 — Окно входа
---
::

После выполненных шагов АРМ включен в домен, и можно входить как под доменной УЗ, так и под УЗ локального пользователя. Клиент puppet-agent уже настроен и работает с ключами от АРМ до миграции, на сервере Комплекса он будет присутствовать в списке узлов под старым именем (рисунок 81).

::sign-image
---
src: /image91.png
sign: Рисунок 81 — АРМ под новой ОС в списке узлов
---
::

Ввиду того, что узел после окончания процедуры остался в группе миграции, его необходимо удалить из нее, как это показано на рисунке 82.

::sign-image
---
src: /image92.jpg
sign: Рисунок 82 — Удаление узла из группы миграции
---
::

Кроме того, на вкладке "Узлы" в перечне узлов присутствует промежуточный узел, используемый при миграции и который следует удалить, выбрав из списка действие "Удалить" в соответствующем столбце (рисунок 83).

::sign-image
---
src: /image93.png
sign: Рисунок 83 — Удаление промежуточного АРМ
---
::

В результате проделанных действий АРМ мигрирован, введен в домен, присутствует в Комплексе (puppet-agent настроен) и готов к работе.

## Миграция с РОСА "Кобальт" с использованием USB

В качестве исходного состояния при миграции на РОСА "Хром" рассматривается АРМ под управлением ОС РОСА "Кобальт" с локальной УЗ и доменной УЗ. У всех пользователей есть данные, которые размещены в домашней директории в стандартных папках (Рабочий стол, Загрузки и др.).

Для начала миграции дополнительно нужно выполнить несколько предварительных действий:

1. на АРМ установить и настроить клиент puppet_agent;
2. в Комплексе настроить шаблон для миграции (рисунок 84);

::sign-image
---
src: /image94.png
sign: Рисунок 84 — Настройка шаблона подготовки
---
::

3. в Комплексе настроить группу узлов с включенными классами (рисунок 85);

::sign-image
---
src: /image95.png
sign: Рисунок 85 — Настройка группы узлов
---
::

4. к АРМ подключить накопитель USB (желательно более 500 Гб свободного пространства) с обязательным наименованием метки тома "usb-migrator", который должен оставаться подключенным до конца миграции;

> Примечание – На накопитель USB копируется зашифрованная резервная копия пользовательских данных и настроек системы, из которой после миграции проводится обратная распаковка. Также по требованию (по умолчанию включено) создается зашифрованный полный образ системы, на который можно откатиться в случае необходимости. Файлы на накопителе USB хранятся в папке с MAC-адресом мигрируемого АРМ. Содержимое накопителя USB рекомендуется хранить до тех пор, пока оно больше не понадобится для восстановления данных. После успешной миграции содержимое накопителя USB рекомендуется удалить для обеспечения безопасности.

5. в Комплексе настроить puppet-класс `rcc_cobalt2chrome_usb`, для чего выбрать пункт меню "Настройки → Puppet ENC → Классы", найти и выбрать этот класс, перейти на вкладку "Параметр класса" для настройки смарт-класса (рисунок 86);

::sign-image
---
src: /image96.png
sign: Рисунок 86 — Параметры для настройки
---
::

6. настроить два смарт-класса, для чего в секции "Поведение по умолчанию" включить флажок "Переопределить", ввести значения и нажать кнопку `Применить`:

- rcc c2c create full image – параметр съемки полного образа системы (true – снять полный образ, false – не создавать образ) (рисунок 87);

::sign-image
---
src: /image97.png
sign: Рисунок 87 — Параметр rcc c2c create full image
---
::

- rcc c2c saving sources – параметр, задающий дополнительные папки (указываются через пробел), которые нужно скопировать в зашифрованный архив и перенести в новую систему (рисунок 88);

::sign-image
---
src: /image98.png
sign: Рисунок 88 — Параметр rcc c2c saving sources
---
::

7. изменить параметры класса для самой группы, для чего открыть пункт меню "Настройки → Группы узлов", выбрать нужную группу (в данном случае c2cUSB), перейти на вкладку "Puppet ENC", перейти к секции "Параметры класса Puppet" внизу страницы для изменения, внести изменения и нажать кнопку `Применить`;

::sign-image
---
src: /image99.png
sign: Рисунок 89 — Изменение параметров для группы
---
::

На рисунке 89 цифрой 1 обозначено значение параметра, которое задает необходимость сохранения полного образа системы, а цифрой 2 – значение параметра, которое задает дополнительные папки (через пробел) для сохранения в образе. Для этой настройки не следует указывать папки пользователя в /home/username, т.к. они уже включены в резервную копию. Настройка предназначена для переноса каких-либо нестандартных пользовательских и системных папок (настроек), но следует учитывать, что, если задать, например, папку /etc, то она будет сохранена, а затем распакована поверх /etc в установленной системе, что приведет к неработоспособности ОС, поэтому рекомендуется с осторожностью включать в образ дополнительные папки.

После выполнения всех действий можно осуществить процедуру миграции, состоящую из следующих шагов:

1. в Комплексе найти имя подлежащего миграции АРМ, включить рядом с его именем параметр, нажать кнопку `Выбрать действие` и выбрать из выпадающего меню "Изменить группу";

2. в открывшемся модальном окне выбрать в выпадающем списке "Группа узлов" группу c2cUSB, после этого нажать на ставшую активной кнопку `Применить` (рисунок 90); выбранный АРМ будет включен в группу c2cUSB для миграции;

::sign-image
---
src: /image100.jpg
sign: Рисунок 90 — Выбор группы
---
::

3. дождаться окончания выполнения манифеста на выбранном АРМ (запустится по времени или вручную), в процессе которого будут сохранены в зашифрованном виде все данные пользователей, настройки puppet-agent и создан полный образ системы на подключенный к АРМ внешний накопитель USB; по окончании будет выведено сообщение о завершении резервного копирования, как на рисунке 91;

::sign-image
---
src: /image101.jpg
sign: Рисунок 91 — Сообщение после резервного копирования
---
::

4. нажать кнопку `ОК` и перезагрузить компьютер;
5. в процессе перезагрузки войти в BIOS/UEFI и выставить загрузку по сети (PXE) или нажать комбинацию клавиш (зависит от производителя материнской платы) и в BOOT MENU выбрать загрузку по сети; начнется загрузка вспомогательного образа с сервера PXE;
6. после загрузки по сети выбрать пункт меню "Control Center Discovery Image" (рисунок 92);

::sign-image
---
src: /image102.jpg
sign: Рисунок 92 — Выбор типа загрузки
---
::

7. после успешной загрузки узла и регистрации на сервере появится сообщение об успешной отправке данных на сервер Комплекса (рисунок );

::sign-image
---
src: /image103.jpg
sign: Рисунок 93 — Сообщение об успешной загрузке
---
::

8. в Комплексе перейти в пункт меню "Узлы → Обнаруженные узлы", выбрать в рабочей области требуемый АРМ и нажать кнопку `Сетевая установка` (рисунок 94);

::sign-image
---
src: /image104.png
sign: Рисунок 94 — Выбор сетевой установки для АРМ
---
::

9. в открывшемся окне (рисунок 95) выбрать ранее настроенную группу узлов c2cUSB и нажать кнопку `Создать узел`; сервер Комплекса передаст АРМ все нужные настройки для загрузки и установки системы РОСА "Хром" по сети;

::sign-image
---
src: /image105.jpg
sign: Рисунок 95 — Включение АРМ в преднастроенную группу
---
::

10. АРМ начнет перезагрузку, после чего опять должен загрузиться по сети (PXE); для дальнейшей установки ОС выбрать пункт "Kickstart Rosa PXElinux" (для режима MBR/Legacy BIOS) (рисунок 96);

::sign-image
---
src: /image106.jpg
sign: Рисунок 96 — Выбор варианта загрузки
---
::

11. после этого на мигрируемом АРМ начнется загрузка и установка ОС РОСА "Хром", занимающая определенное время (рисунок 97);

::sign-image
---
src: /image107.jpg
sign: Рисунок 97 — Установка ОС РОСА "Хром"
---
::

12. после окончания установки АРМ будет перезагружен, можно убрать загрузку в BIOS по сети (PXE) и выставить загрузку с жесткого диска, после чего должна загрузиться ОС РОСА "Хром" (рисунок 98);

::sign-image
---
src: /image108.jpg
sign: Рисунок 98 — Загрузка РОСА "Хром"
---
::

**Следует обратить внимание**, что после первой загрузки РОСА "Хром" не нужно входить под УЗ пользователя, так как в это время копируются пользовательские данные, а по окончании будет выполнена перезагрузка в автоматическом режиме. На экране входа отобразятся локальные пользователи, которые были ранее в ОС РОСА "Кобальт" (рисунок 99);

::sign-image
---
src: /image90.png
sign: Рисунок 99 — Окно входа
---
::

После выполненных шагов АРМ включен в домен, и можно входить как под доменной УЗ, так и под УЗ локального пользователя. Клиент puppet-agent уже настроен и работает с ключами от АРМ до миграции. На сервере Комплекса он будет присутствовать в списке узлов под старым именем (рисунок 100).

::sign-image
---
src: /image109.png
sign: Рисунок 100 — АРМ под новой ОС в списке узлов
---
::

Теперь USB-накопитель можно извлечь из компьютера.

Ввиду того, что узел после окончания процедуры остался в группе миграции, его необходимо удалить из группы, как это показано на рисунке 101.

::sign-image
---
src: /image92.png
sign: Рисунок 101 — Удаление узла из группы миграции
---
::

Кроме того, на вкладке "Узлы" в перечне узлов присутствует промежуточный узел, используемый при миграции и который следует удалить, выбрав из списка действие "Удалить" в соответствующем столбце. Для подтверждения удаления необходимо нажать кнопку `Подтвердить` в появившемся модальном окне.

В результате проделанных действий АРМ мигрирован, введен в домен, присутствует в Комплексе (puppet-agent настроен) и готов к работе.
