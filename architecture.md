# Архитектура проекта

Документ обязателен к прочтению перед разработкой вместе с `AGENTS.md` и `hierarchy-analysis.md`.

## Цель
CLI собирает структуру Markdown из `content/<NNN.slug>`, резолвит пути к картинкам в `public/images/<slug>/...`, склеивает `bundle.md` и рендерит PDF через Pandoc + LaTeX.

## Рабочее окружение
- Всю разработку ведём в активированном Python venv (3.11+); зависимости ставим только туда.

## Текущее состояние (факт)
- Реализованы и покрыты тестами: `walker.py`, `images.py`, `bundle.py`, `config.py`; базовая типизация включена.
- Отсутствуют `pandoc_runner.py` и `cli.py`, нет связки пайплайна и вызова Pandoc.
- Бандл сейчас использует только `DEFAULT_BUNDLE_METADATA`; метаданные из `config`/CLI ещё не прокидываются.

## Модули и ответственности
- `cli.py`: парсинг флагов (`--md-dir`, `--config`, `--style`, output), вызов pipeline, человекочитаемые ошибки.
- `config.py`: чтение `config/project.yml`, валидация путей, маппинг стиля на `styles/<name>.yaml` и шаблона.
- `walker.py`: обход Markdown по правилам из `hierarchy-analysis.md`, отдаёт отсортированный список файлов.
- `images.py`: резолв путей картинок: `content/.../020100.file.md` + `image1.png` ⇒ `/images/<doc-slug>/.../file/image1.png`, переписывание коротких ссылок `::sign-image`.
- `bundle.py`: склейка Markdown в порядке обхода, вставка разделителей/метаданных, опционально запись на диск.
- `pandoc_runner.py`: подготовка аргументов, вызов Pandoc/xelatex, обработка ошибок процессов.
- `logging.py` (или утилита): единообразные сообщения и контекст путей.

## Инварианты структуры контента
- Точка входа — `content/<NNN.slug>/0.index.md` если есть, иначе содержимое корня по числовому порядку; `index.md` без префикса эквивалентен `0.index.md` на уровне.
- Порядок внутри каталога: сначала `0.index.md`/`index.md`, затем `.md` с числовым префиксом, после них файлы без префикса (алфавитно). Подкаталоги сортируются аналогично, обход рекурсивный.
- Служебные файлы (включая `.navigation.yml` и каталог `doc/` в `003.cu`) пропускаются с предупреждением.
- Если раздел имеет текст — кладут `0.index.md`; если нужен только заголовок, используют `.navigation.yml` с `title` вместо индекса.
- Маппинг картинок: slug документа = имя каталога `content/<NNN.slug>` без числового префикса; путь картинки зеркалирует путь markdown без префиксов под `/images/<slug>/.../imageNN.ext`.
- Подробные текущие цифры по дереву и примеры веток — в `hierarchy-analysis.md`.

## Поток данных (pipeline)
1) CLI → загрузка конфига (`config/project.yml`) → валидация входных путей и стиля.
2) `walker.walk(md_root)` возвращает `list[Path]` Markdown-файлов в нужном порядке и список предупреждений по структуре:
   - `0.index.md` или `index.md` первым на уровне; при отсутствии — warning, содержимое по числовому порядку, потом безпрефиксные файлы.
   - Директории/файлы без числовых префиксов допускаются (например, `000.dev`, `1.cert/2.nocert`), сортируются после числовых.
   - Служебные файлы (`.navigation.yml` и прочие не `.md`) игнорируются с предупреждением.
   - Каталог `doc/` можно пропускать.
3) `bundle.build(order, image_resolver)` читает файлы, переписывает ссылки на картинки через `images.resolve_image_path`, формирует текст `bundle.md`.
4) `pandoc_runner.render(bundle_path, style_path, template_path, output_pdf)` вызывает Pandoc; ошибки процесса пробрасываются как читаемые исключения.

## Контракты и типы (минимум)
- `walk(md_root: Path) -> list[Path]`: бросает `ValueError` при отсутствии входа или несоответствии структуре.
- `resolve_image_path(md_path: Path, image_name: str) -> Path`: возвращает абсолютный путь `/images/<slug>/.../image.ext` без файловой системы; не читает диск.
- `rewrite_images(md_path: Path, text: str) -> str`: переписывает `::sign-image` и короткие пути в абсолютные.
- `build(order: Sequence[Path], image_resolver: Callable[[Path, str], Path]) -> str`: возвращает содержимое бандла; запись на диск вынесена в вызывающий код.
- `render(bundle_path: Path, style: Path, template: Path, output: Path) -> None`: только запуск Pandoc; логика подготовки аргументов внутри.

## Конфиг
Ожидаемый минимальный YAML (`config/project.yml`):
```yaml
content_root: content
images_root: public/images
style: style
template: templates/gost.tex
metadata:
  title: "Название документа"
  doctype: "Тип документа"
  date: "2024-01-01"
```
Поля и валидация:
- `content_root` (обязательно) — каталог с наборами Markdown; проверяется наличие и директория.
- `images_root` (обязательно) — корень картинок; проверяется наличие и директория.
- `style` (обязательно) — имя стиля без суффикса, маппится на `styles/<style>.yaml`; проверяется существование файла.
- `template` (обязательно) — путь к LaTeX-шаблону (по умолчанию `templates/gost.tex`); проверяется существование файла.
- `filters` (опционально) — список Lua-фильтров для Pandoc.
- `output` (опционально) — путь к итоговому PDF, если не задан CLI.
- `metadata` (опционально) — значения для фронтматтера бандла (см. ниже). CLI может переопределять отдельные поля.

Расширения: поддержка кастомных стилей (`styles/<name>.yaml`), альтернативных шаблонов, переопределение выходного каталога, добавление фильтров.

## Фронтматтер и сборка `bundle.md`
- Фронтматтер бандла — YAML-межа в начале файла. Обязательные ключи для шаблона: `title`, `doctype`, `date`. Рекомендуемые: `author` (идёт в PDF метаданные), `logo` (путь до логотипа, если нужно), `header.center` (строка в колонтитуле), `titlepage.org`, `titlepage.product`, `titlepage.index`. Все поля берутся из `config.metadata`, могут быть переопределены CLI; если поле не задано, опциональные блоки в `gost.tex` опускаются через `$if(...)$`.
- Содержимое бандла формируется по порядку `walker.walk(md_root)`. Автоматические страничные разрывы не вставляются; разрывы добавляются авторами вручную в Markdown при необходимости.
- Front matter отдельных markdown-файлов используется для заголовка раздела (`title`) при построении структуры/оглавления; остальные поля игнорируются. Основная мета документа задаётся целиком в фронтматтере бандла.
- Ссылки на изображения переписываются через `images.resolve_image_path`/`rewrite_images` до записи в бандл.
- Итог: `bundle.md` = фронтматтер бандла + контент файлов (с разделителями), далее Pandoc вызывается с `--toc` и указанным шаблоном/стилем.

## Ошибки и валидация
- Ранние проверки: существование `md_root`, доступности стиля и шаблона. Для входной директории фиксируем предупреждения, если нет `0.index.md`/`index.md`, есть файлы без префикса или лишние служебные файлы.
- Сообщения включают путь и причину (пример: `Missing file: content/003.cu/0.index.md`).
- При вызове Pandoc логируем команду и stderr.

## Тестовые опорные точки
- Юнит: `walk` (порядок обхода), `resolve_image_path`/`rewrite_images`, разбор конфига.
- Интеграция: `build` на маленьком дереве из `tests/fixtures` — порядок и корректные пути картинок.
- CLI-smoke: успешный прогон с подменой subprocess, негативный случай на битой ссылке/файле.

## Расширяемость
- Новые стили — добавлением `styles/<name>.yaml` без изменения кода.
- Альтернативные шаблоны — через конфиг.
- Поддержка других входных деревьев — сменой `--md-dir` при сохранении правил обхода из `hierarchy-analysis.md`.
